{"mappings":"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","sources":["src/main.ts"],"sourcesContent":["import { vec2 } from 'gl-matrix';\n\ninterface Car {\n  // geometry\n  L: number; // distance from rear axle to front axle\n  box_width: number;\n  box_length: number;\n  wheel_width: number;\n  wheel_diameter: number;\n  gauge: number;\n\n  // state\n  x: number; // position of centre of rear axle\n  y: number;\n  theta: number; // car heading in radians from +X\n\n  // control\n  s: number; // speed\n  phi: number; // steer in radians from car's heading\n}\n\nmain();\n\nfunction draw_car_body(ctx: CanvasRenderingContext2D, car: Car) {\n  ctx.strokeRect(\n    -(car.box_length - car.L) / 2,\n    -car.box_width / 2,\n    car.box_length,\n    car.box_width,\n  );\n}\n\nfunction draw_wheel(ctx: CanvasRenderingContext2D, car: Car) {\n  ctx.strokeRect(\n    -car.wheel_diameter / 2,\n    -car.wheel_width / 2,\n    car.wheel_diameter,\n    car.wheel_width,\n  );\n}\n\nfunction paint_car(ctx: CanvasRenderingContext2D, car: Car, zoom: number) {\n  ctx.resetTransform();\n  ctx.clearRect(0, 0, 720, 720);\n\n  ctx.translate(360, 360);\n  ctx.scale(zoom, -zoom);\n\n  ctx.lineJoin = 'round';\n\n  const draw_radius = 0.02;\n\n  ctx.lineWidth = draw_radius;\n\n  ctx.translate(car.x, car.y);\n  ctx.rotate(car.theta);\n\n  ctx.beginPath();\n  ctx.arc(0, 0, 0.05, 0, 2 * Math.PI);\n  ctx.fill();\n\n  draw_car_body(ctx, car);\n\n  ctx.save();\n  ctx.translate(0, car.gauge / 2);\n  draw_wheel(ctx, car);\n  ctx.restore();\n\n  ctx.save();\n  ctx.translate(0, -car.gauge / 2);\n  draw_wheel(ctx, car);\n  ctx.restore();\n\n  let outer_wheel_angle = 0;\n  let inner_wheel_angle = 0;\n  let turning_radius = Infinity;\n\n  if (car.phi != 0) {\n    turning_radius = car.L / Math.tan(Math.abs(car.phi));\n\n    outer_wheel_angle =\n      Math.sign(car.phi) * Math.atan(car.L / (turning_radius + car.gauge / 2));\n    inner_wheel_angle =\n      Math.sign(car.phi) * Math.atan(car.L / (turning_radius - car.gauge / 2));\n  }\n\n  ctx.save();\n  ctx.strokeStyle = 'red';\n  ctx.beginPath();\n  if (isFinite(turning_radius)) {\n    ctx.arc(\n      0,\n      Math.sign(car.phi) * turning_radius,\n      turning_radius,\n      0,\n      Math.PI * 2,\n    );\n  } else {\n    ctx.moveTo(-1000, 0);\n    ctx.lineTo(1000, 0);\n  }\n\n  ctx.stroke();\n  ctx.closePath();\n  ctx.restore();\n\n  ctx.save();\n  ctx.translate(car.L, car.gauge / 2);\n  ctx.rotate(car.phi > 0 ? inner_wheel_angle : outer_wheel_angle);\n  draw_wheel(ctx, car);\n  ctx.restore();\n\n  ctx.save();\n  ctx.translate(car.L, -car.gauge / 2);\n  ctx.rotate(car.phi > 0 ? outer_wheel_angle : inner_wheel_angle);\n  draw_wheel(ctx, car);\n  ctx.restore();\n}\n\nfunction main() {\n  const car: Car = {\n    L: 3,\n    box_length: 4,\n    box_width: 2,\n    wheel_width: 0.25,\n    wheel_diameter: 0.75,\n    gauge: 1.5,\n\n    x: 0,\n    y: 0,\n    theta: Math.PI / 2,\n\n    s: 0,\n    phi: 0,\n  };\n\n  let zoom = 40;\n\n  const simulation_canvas: HTMLCanvasElement = document.getElementById(\n    'simulation',\n  ) as HTMLCanvasElement;\n  const simulation_ctx = simulation_canvas.getContext('2d');\n\n  if (simulation_ctx) paint_car(simulation_ctx, car, zoom);\n\n  let left = false;\n  let right = false;\n  let up = false;\n  let down = false;\n\n  window.addEventListener('keydown', (event) => {\n\n    if (event.key === 'ArrowLeft') left = true;\n    if (event.key === 'ArrowRight') right = true;\n    if (event.key === 'ArrowUp') up = true;\n    if (event.key === 'ArrowDown') down = true;\n\n    let dirty = false;\n\n    if (event.key === '+') {\n      zoom *= 2;\n      dirty = true;\n    }\n\n    if (event.key === '-') {\n      zoom /= 2;\n      dirty = true;\n    }\n\n    if (dirty || left || right || up || down) window.requestAnimationFrame(step);\n  });\n\n  window.addEventListener('keyup', (event) => {\n    if (event.key === 'ArrowLeft') left = false;\n    if (event.key === 'ArrowRight') right = false;\n    if (event.key === 'ArrowUp') up = false;\n    if (event.key === 'ArrowDown') down = false;\n  });\n\n  let start, prev_timestamp;\n  let stale = false;\n\n  function step(timestamp: DOMHighResTimeStamp) {\n    if (start === undefined) {\n      start = timestamp;\n    }\n\n    const elapsed = timestamp - prev_timestamp;\n\n    if (isFinite(elapsed) && prev_timestamp !== timestamp) {\n      if (!stale) {\n        // TODO update car.xy, car.theta according to car.s, car.phi, elapsed\n        car.x += (elapsed / 400) * car.s * Math.cos(car.theta);\n        car.y += (elapsed / 400) * car.s * Math.sin(car.theta);\n        car.theta += (((elapsed / 400) * car.s) / car.L) * Math.tan(car.phi);\n\n        // then update car.s, car.phi according to keyboard input\n        if (left) car.phi += elapsed / 1000;\n        if (right) car.phi -= elapsed / 1000;\n        car.phi = Math.min(car.phi, Math.PI * 0.4);\n        car.phi = Math.max(car.phi, -Math.PI * 0.4);\n\n        if (up) car.s = 1;\n        else if (down) car.s = -1;\n        else car.s = 0;\n      }\n\n      if (simulation_ctx) paint_car(simulation_ctx, car, zoom);\n    }\n\n    prev_timestamp = timestamp;\n    if (left || right || up || down) {\n      window.requestAnimationFrame(step);\n      stale = false;\n    } else stale = true;\n  }\n\n  window.requestAnimationFrame(step);\n}\n"],"names":["$ad2bcec7a0192558$var$draw_wheel","ctx","car","strokeRect","wheel_diameter","wheel_width","$ad2bcec7a0192558$var$paint_car","zoom","resetTransform","clearRect","translate","scale","lineJoin","lineWidth","x","y","rotate","theta","beginPath","arc","Math","PI","fill","box_length","L","box_width","$ad2bcec7a0192558$var$draw_car_body","save","gauge","restore","outer_wheel_angle","inner_wheel_angle","turning_radius","Infinity","phi","tan","abs","sign","atan","strokeStyle","isFinite","moveTo","lineTo","stroke","closePath","s","simulation_ctx","document","getElementById","getContext","start","prev_timestamp","left","right","up","down","window","addEventListener","event","key","dirty","requestAnimationFrame","step","stale","timestamp","undefined","elapsed","cos","sin","min","max","$ad2bcec7a0192558$var$main"],"version":3,"file":"index.662b8268.js.map"}